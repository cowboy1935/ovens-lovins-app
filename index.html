<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Chef Recipes</title>

    <!-- PWA -->
    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#111111" />
    <link rel="apple-touch-icon" href="/icons/icon-192.png" />

    <!-- Styles -->
    <link rel="stylesheet" href="/css/app.css" />
</head>

<body>

    <!-- -------------------- NAVIGATION -------------------- -->
    <div class="nav-container">
        <button class="nav-btn" onclick="window.location.href='index.html'">Home</button>
        <button class="nav-btn" onclick="window.location.href='upload.html'">Add Recipe</button>
        <button class="nav-btn" onclick="window.location.href='index.html#favorites'">Favorites</button>
        <button class="nav-btn" onclick="window.location.href='grocery.html'">Grocery List</button>
        <button id="continue-btn" class="nav-btn" style="display:none;">Continue Recipe</button>
    </div>

    <!-- -------------------- PAGE HEADER -------------------- -->
    <h1 class="page-title">Chef Recipes</h1>

    <!-- -------------------- FILTER BAR -------------------- -->
    <div class="filter-bar">
        <select id="mealTypeFilter" onchange="renderRecipes()">
            <option value="">All Meals</option>
            <option value="Breakfast">Breakfast</option>
            <option value="Lunch">Lunch</option>
            <option value="Dinner">Dinner</option>
            <option value="Dessert">Dessert</option>
            <option value="Snack">Snack</option>
        </select>

        <input id="searchBox" type="text" placeholder="Search‚Ä¶" oninput="renderRecipes()" />
    </div>

    <!-- -------------------- QUICK FILTER CHIPS -------------------- -->
    <div class="quick-filters">
        <button class="filter-chip active" data-filter="all">All</button>
        <button class="filter-chip" data-filter="favorites">Favorites</button>
        <button class="filter-chip" data-filter="chef">Chef Ramsay</button>
        <button class="filter-chip" data-filter="budget">Budget</button>
    </div>

    <!-- -------------------- RECIPE RESULTS -------------------- -->
    <div id="recipe-list"></div>

    <!-- Load API logic -->
    <script src="/js/api.js"></script>

    <script>
        let allRecipes = [];
        let currentQuickFilter = "all";

        // -------- CONTINUE BUTTON --------
        function enableContinueButton() {
            const last = localStorage.getItem("last_recipe_id");
            if (last) {
                const btn = document.getElementById("continue-btn");
                btn.style.display = "inline-block";
                btn.onclick = () => window.location.href = `recipe.html?id=${last}`;
            }
        }

        // -------- QUICK FILTER CHIPS --------
        function setQuickFilter(filter) {
            currentQuickFilter = filter;
            document.querySelectorAll(".filter-chip").forEach(btn => {
                btn.classList.toggle("active", btn.dataset.filter === filter);
            });
            renderRecipes();
        }

        function setupQuickFilters() {
            document.querySelectorAll(".filter-chip").forEach(btn => {
                btn.addEventListener("click", () => {
                    setQuickFilter(btn.dataset.filter);
                });
            });

            // If we came from the nav "Favorites" button
            if (window.location.hash === "#favorites") {
                setQuickFilter("favorites");
            }
        }

        // -------- FAVORITE TOGGLE --------
        async function toggleFavorite(recipe, heartEl) {
            try {
                if (recipe.is_favorite) {
                    await window.api.unfavoriteRecipe(recipe.id);
                    recipe.is_favorite = false;
                } else {
                    await window.api.favoriteRecipe(recipe.id);
                    recipe.is_favorite = true;
                }
            } catch (err) {
                console.error("Favorite toggle failed:", err);
                // if request failed, don't lie with UI
                return;
            }

            heartEl.classList.toggle("off", !recipe.is_favorite);
            heartEl.textContent = recipe.is_favorite ? "‚ù§Ô∏è" : "ü§ç";

            // If we're viewing only favorites, update list
            if (currentQuickFilter === "favorites") {
                renderRecipes();
            }
        }

        // -------- LOAD ALL RECIPES --------
        async function init() {
            enableContinueButton();
            setupQuickFilters();

            try {
                allRecipes = await window.api.getRecipes();
                renderRecipes();
            } catch (error) {
                console.error(error);
                document.getElementById("recipe-list").innerHTML =
                    "<p style='color:#777'>Error loading recipes.</p>";
            }
        }

        // -------- RENDER LIST --------
        function renderRecipes() {
            const mealType = document.getElementById("mealTypeFilter").value;
            const search = document.getElementById("searchBox").value.toLowerCase();
            const container = document.getElementById("recipe-list");

            let filtered = allRecipes.slice();

            if (mealType) {
                filtered = filtered.filter(r => r.meal_type === mealType);
            }

            if (search.trim()) {
                filtered = filtered.filter(r =>
                    r.title.toLowerCase().includes(search)
                );
            }

            if (currentQuickFilter === "favorites") {
                filtered = filtered.filter(r => r.is_favorite);
            } else if (currentQuickFilter === "chef") {
                filtered = filtered.filter(r => r.source_type === "chef");
            } else if (currentQuickFilter === "budget") {
                filtered = filtered.filter(r => r.is_budget_friendly);
            }

            container.innerHTML = "";

            if (!filtered.length) {
                container.innerHTML = "<p style='color:#777'>No recipes found.</p>";
                return;
            }

            filtered.forEach(recipe => {
                const card = document.createElement("div");
                card.className = "recipe-card";

                card.innerHTML = `
                    <h3>${recipe.title}</h3>
                    <div class="tags">
                        ${recipe.meal_type ? `<span class="tag">${recipe.meal_type}</span>` : ""}
                        ${recipe.category ? `<span class="tag">${recipe.category}</span>` : ""}
                        <span class="tag">${recipe.source_type}</span>
                        <span class="fav-heart ${recipe.is_favorite ? "" : "off"}" data-id="${recipe.id}">
                            ${recipe.is_favorite ? "‚ù§Ô∏è" : "ü§ç"}
                        </span>
                    </div>
                `;

                // click card = open recipe
                card.addEventListener("click", () => viewRecipe(recipe.id));

                // click heart = toggle favorite ONLY
                const heartEl = card.querySelector(".fav-heart");
                heartEl.addEventListener("click", (evt) => {
                    evt.stopPropagation(); // don't navigate
                    toggleFavorite(recipe, heartEl);
                });

                container.appendChild(card);
            });
        }

        function viewRecipe(id) {
            window.location.href = `recipe.html?id=${id}`;
        }

        init();

        // -------- SERVICE WORKER --------
        if ("serviceWorker" in navigator) {
            window.addEventListener("load", () => {
                navigator.serviceWorker
                    .register("/service-worker.js")
                    .catch(err => console.error("SW failed:", err));
            });
        }
    </script>

</body>

</html>