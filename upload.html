<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Add Recipe – Ovens Lovin’s</title>

    <!-- PWA -->
    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#111111" />
    <link rel="apple-touch-icon" href="/icons/icon-192.png" />

    <!-- Styles -->
    <link rel="stylesheet" href="/css/app.css" />
</head>

<body>

    <!-- NAVIGATION BAR -->
    <div class="nav-container">
        <button class="nav-btn" onclick="window.location.href='index.html'">Home</button>
        <button class="nav-btn" onclick="window.location.href='upload.html'">Add Recipe</button>
        <button class="nav-btn" onclick="window.location.href='index.html#favorites'">Favorites</button>
        <button class="nav-btn" onclick="window.location.href='grocery.html'">Grocery List</button>
    </div>

    <h1 class="page-title">Add a New Recipe</h1>

    <main style="padding: 15px;">

        <!-- BASIC INFO -->
        <div class="form-section">
            <h2>Recipe Details</h2>

            <label for="title">Title *</label>
            <input id="title" type="text" placeholder="Beef Wellington, Sticky Toffee Pudding…" />

            <label for="meal-type">Meal Type *</label>
            <select id="meal-type">
                <option value="">Select meal type…</option>
                <option value="Breakfast">Breakfast</option>
                <option value="Lunch">Lunch</option>
                <option value="Dinner">Dinner</option>
                <option value="Dessert">Dessert</option>
                <option value="Snack">Snack</option>
            </select>

            <label for="category">Category (optional)</label>
            <input id="category" type="text" placeholder="e.g., Chicken, Pasta, Salad…" />

            <div style="margin-top: 10px;">
                <label style="display:flex; align-items:center; gap:8px; font-size:0.95rem;">
                    <input type="checkbox" id="is-budget" style="width:auto;" />
                    Budget friendly
                </label>
            </div>
        </div>

        <!-- INGREDIENTS -->
        <div class="form-section">
            <h2>Ingredients</h2>
            <p style="color:#999; font-size:0.9rem; margin-bottom:8px;">
                Add each ingredient on its own row. Only name is required.
            </p>

            <div id="ingredients-container"></div>

            <button type="button" class="btn btn-secondary" id="add-ingredient-btn">
                + Add Ingredient Row
            </button>
        </div>

        <!-- INSTRUCTIONS -->
        <div class="form-section">
            <h2>Instructions</h2>

            <label for="prep">Prep Instructions</label>
            <textarea id="prep" rows="4" placeholder="Chop, marinate, preheat…" style="width:100%;"></textarea>

            <label for="cook" style="margin-top:10px;">Cooking Instructions</label>
            <textarea id="cook" rows="4" placeholder="Cook, simmer, bake…" style="width:100%;"></textarea>
        </div>

        <!-- ACTIONS -->
        <div style="margin-top: 15px; margin-bottom:25px;">
            <button id="save-recipe-btn" class="btn">Save Recipe</button>
        </div>

    </main>

    <script src="/js/api.js"></script>
    <script>
        function createIngredientRow() {
            const row = document.createElement("div");
            row.className = "ingredient-row";

            row.innerHTML = `
                <input
                    type="text"
                    class="ingredient-name"
                    placeholder="Ingredient (required)" />

                <input
                    type="text"
                    class="ingredient-qty"
                    placeholder="Qty (e.g. 2, 1½, pinch)" />

                <input
                    type="text"
                    class="ingredient-unit"
                    placeholder="Unit (lb, cup, tsp…)" />
            `;

            return row;
        }

        function addIngredientRow() {
            const container = document.getElementById("ingredients-container");
            container.appendChild(createIngredientRow());
        }

        async function saveRecipe() {
            const title = document.getElementById("title").value.trim();
            const mealType = document.getElementById("meal-type").value;
            const category = document.getElementById("category").value.trim();
            const isBudget = document.getElementById("is-budget").checked;
            const prep = document.getElementById("prep").value.trim();
            const cook = document.getElementById("cook").value.trim();

            if (!title) {
                alert("Please enter a recipe title.");
                return;
            }

            if (!mealType) {
                alert("Please choose a meal type.");
                return;
            }

            // Collect ingredients
            const rows = document.querySelectorAll(".ingredient-row");
            const ingredients = [];

            rows.forEach(row => {
                const name = row.querySelector(".ingredient-name").value.trim();
                const qty = row.querySelector(".ingredient-qty").value.trim();
                const unit = row.querySelector(".ingredient-unit").value.trim();

                if (!name) return; // skip empty rows

                ingredients.push({
                    name,
                    quantity: qty || null,
                    unit: unit || null
                });
            });

            if (!ingredients.length) {
                alert("Add at least one ingredient.");
                return;
            }

            const recipePayload = {
                title,
                meal_type: mealType,
                category: category || null,
                source_type: "custom",           // user-added recipes
                is_budget_friendly: isBudget,
                base_recipe_id: null,
                prep_instructions: prep || "",
                cook_instructions: cook || "",
                ingredients
            };

            try {
                const result = await window.api.createRecipe(recipePayload);
                if (result && result.id) {
                    // Jump straight to the recipe view
                    window.location.href = `recipe.html?id=${result.id}`;
                } else {
                    alert("Recipe saved, but could not read the new ID.");
                }
            } catch (err) {
                console.error("Failed to save recipe:", err);
                alert("Could not save recipe. Please try again.");
            }
        }

        function initUploadPage() {
            // start with 3 ingredient rows
            addIngredientRow();
            addIngredientRow();
            addIngredientRow();

            document
                .getElementById("add-ingredient-btn")
                .addEventListener("click", addIngredientRow);

            document
                .getElementById("save-recipe-btn")
                .addEventListener("click", saveRecipe);
        }

        initUploadPage();
    </script>

    <!-- SERVICE WORKER -->
    <script>
        if ("serviceWorker" in navigator) {
            window.addEventListener("load", () => {
                navigator.serviceWorker
                    .register("/service-worker.js")
                    .catch(err => console.error("SW failed:", err));
            });
        }
    </script>

</body>

</html>